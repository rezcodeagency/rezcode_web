---
/**
 * SERVICES COMPONENT - FARELL RHEZKY ALVIANTO
 * Deskripsi: Slider formal "Our Services" dengan indikator progres visual.
 */

import servicesData from "../../data/services.json";
import {
  Palette,
  Code2,
  Database,
  Layout,
  Search,
  PenTool,
  Share2,
  BarChart3,
  Settings,
  Users,
  ClipboardList,
  ChevronLeft,
  ChevronRight,
  MessageSquare,
} from "lucide-react";

/**
 * ICON MAPPING
 * Menghubungkan data ikon dari JSON ke komponen Lucide.
 */
const IconMap: any = {
  Palette,
  Code2,
  Database,
  Layout,
  Search,
  PenTool,
  Share2,
  BarChart3,
  Settings,
  Users,
  ClipboardList,
};
---

<section
  id="services"
  class="py-24 bg-[#03050a] overflow-hidden"
  aria-label="We Provide"
>
  <div class="max-w-6xl mx-auto px-6">
    <header
      class="flex flex-col md:flex-row md:items-end justify-between gap-8 mb-16"
    >
      <div>
        <h2
          class="text-4xl font-black text-white mb-4 tracking-tight uppercase"
        >
          We <span class="text-brand-primary">Provide</span>
        </h2>
        <div class="h-1.5 w-16 bg-brand-primary rounded-full"></div>
      </div>

      <nav class="flex gap-4">
        <button
          id="prev-btn"
          aria-label="Previous slide"
          class="p-4 rounded-2xl border border-white/5 bg-white/5 text-white hover:bg-brand-primary transition-all duration-300 active:scale-90 shadow-xl"
        >
          <ChevronLeft size={24} aria-hidden="true" />
        </button>
        <button
          id="next-btn"
          aria-label="Next slide"
          class="p-4 rounded-2xl border border-white/5 bg-white/5 text-white hover:bg-brand-primary transition-all duration-300 active:scale-90 shadow-xl"
        >
          <ChevronRight size={24} aria-hidden="true" />
        </button>
      </nav>
    </header>

    <div
      id="formal-slider"
      class="flex gap-6 overflow-x-auto snap-x snap-mandatory scrollbar-hide scroll-smooth"
    >
      {
        servicesData.map((service) => {
          const Icon = IconMap[service.icon] || Code2;
          return (
            <article class="w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)] flex-shrink-0 snap-start">
              <div class="group relative h-[380px] bg-[#0a0d14] border border-white/5 p-10 rounded-[2.5rem] hover:border-brand-primary/40 transition-all duration-500 flex flex-col overflow-hidden shadow-2xl shadow-black/50">
                <div class="mb-8">
                  <div class="w-14 h-14 rounded-2xl bg-brand-primary/10 flex items-center justify-center text-brand-primary group-hover:scale-110 transition-transform duration-500">
                    <Icon size={28} aria-hidden="true" />
                  </div>
                </div>

                <h3 class="text-2xl font-bold text-white mb-4 tracking-tight">
                  {service.title}
                </h3>
                <p class="text-brand-secondary/80 text-sm leading-relaxed line-clamp-4 group-hover:opacity-10 transition-opacity duration-500">
                  {service.description}
                </p>

                <div class="absolute inset-x-0 bottom-0 p-8 translate-y-full opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-500 ease-[cubic-bezier(0.23,1,0.32,1)] bg-gradient-to-t from-[#0a0d14] via-[#0a0d14] to-transparent">
                  <a
                    href="#contact"
                    class="flex items-center justify-center gap-3 w-full py-5 bg-brand-primary text-white rounded-2xl font-bold text-xs uppercase tracking-widest hover:bg-brand-secondary transition-all shadow-2xl shadow-brand-primary/30"
                  >
                    <MessageSquare size={18} aria-hidden="true" />
                    Contact Us Now
                  </a>
                </div>
              </div>
            </article>
          );
        })
      }
    </div>

    <div class="mt-12 flex justify-center">
      <div class="h-1 bg-white/5 w-48 rounded-full overflow-hidden">
        <div
          id="progress-bar"
          class="h-full bg-brand-primary w-0 transition-all duration-300 ease-out shadow-[0_0_8px_rgba(var(--brand-primary-rgb),0.5)]"
        >
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Menghilangkan Scrollbar Default */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Optimasi GPU untuk Animasi Halus */
  .group,
  #progress-bar {
    will-change: transform, opacity, width;
  }
</style>

<script>
  const slider = document.getElementById("formal-slider") as HTMLElement;
  const nextBtn = document.getElementById("next-btn");
  const prevBtn = document.getElementById("prev-btn");
  const progressBar = document.getElementById("progress-bar");

  if (slider && nextBtn && prevBtn && progressBar) {
    let cachedScrollWidth = slider.scrollWidth;
    let cachedClientWidth = slider.clientWidth;
    let cardWidth = (slider.querySelector("article")?.clientWidth || 0) + 24;

    const updateCache = () => {
      cachedScrollWidth = slider.scrollWidth;
      cachedClientWidth = slider.clientWidth;
      cardWidth = (slider.querySelector("article")?.clientWidth || 0) + 24;
    };

    window.addEventListener("resize", updateCache, { passive: true });

    let frameRequested = false;

    const updateProgress = () => {
      if (frameRequested) return;
      frameRequested = true;

      requestAnimationFrame(() => {
        const maxScroll = cachedScrollWidth - cachedClientWidth;
        const scrollPercent =
          maxScroll > 0 ? (slider.scrollLeft / maxScroll) * 100 : 0;
        progressBar.style.width = `${Math.max(10, scrollPercent)}%`;
        frameRequested = false;
      });
    };

    const scrollNext = () => {
      if (slider.scrollLeft + cachedClientWidth >= cachedScrollWidth - 10) {
        slider.scrollTo({ left: 0, behavior: "smooth" });
      } else {
        slider.scrollBy({ left: cardWidth, behavior: "smooth" });
      }
    };

    nextBtn.addEventListener("click", scrollNext);
    prevBtn.addEventListener("click", () => {
      slider.scrollBy({ left: -cardWidth, behavior: "smooth" });
    });

    slider.addEventListener("scroll", updateProgress, { passive: true });

    let autoSlide = setInterval(scrollNext, 6000);
    slider.addEventListener("mouseenter", () => clearInterval(autoSlide));
    slider.addEventListener(
      "mouseleave",
      () => (autoSlide = setInterval(scrollNext, 6000)),
    );

    updateProgress();
  }
</script>
