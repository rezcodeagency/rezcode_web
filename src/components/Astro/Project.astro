---
import { ChevronLeft, ChevronRight, ExternalLink } from "lucide-react";
import projects from "../../data/projects.json";
import { Image } from "astro:assets";
---

<section id="project" class="py-24 bg-brand-dark relative overflow-hidden">
  <!-- Grid Background -->
  <div
    class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:40px_40px] [mask-image:radial-gradient(ellipse_80%_80%_at_50%_50%,black,transparent)] pointer-events-none"
  >
  </div>

  <div class="max-w-7xl mx-auto px-6 relative z-10">
    <div class="text-center mb-16" data-aos="fade-up">
      <h2
        class="text-brand-secondary font-bold tracking-[0.3em] uppercase text-xs mb-4"
      >
        Selected Missions
      </h2>
      <h2 class="text-4xl md:text-6xl font-black text-white tracking-tighter">
        Proven Result
      </h2>
      <p
        class="text-brand-light/60 mt-4 max-w-2xl mx-auto text-lg leading-relaxed"
      >
        Real projects, real results. Our portfolio features cutting-edge
        solutions delivered to satisfied clients.
      </p>
    </div>

    <!-- Container -->
    <div class="relative px-0 md:px-4">
      {
        projects.length > 1 && (
          <>
            <button
              id="project-prev"
              aria-label="Previous project"
              class="hidden xl:flex absolute left-0 top-1/2 -translate-y-1/2 -translate-x-12 z-20 w-14 h-14 items-center justify-center rounded-2xl bg-white/5 backdrop-blur-2xl border border-white/10 hover:bg-brand-primary hover:border-brand-primary hover:scale-110 transition-all duration-500 text-white group shadow-2xl shadow-black/50"
            >
              <ChevronLeft
                className="w-7 h-7 group-hover:animate-pulse"
                aria-hidden="true"
              />
            </button>

            <button
              id="project-next"
              aria-label="Next project"
              class="hidden xl:flex absolute right-0 top-1/2 -translate-y-1/2 translate-x-12 z-20 w-14 h-14 items-center justify-center rounded-2xl bg-white/5 backdrop-blur-2xl border border-white/10 hover:bg-brand-primary hover:border-brand-primary hover:scale-110 transition-all duration-500 text-white group shadow-2xl shadow-black/50"
            >
              <ChevronRight
                className="w-7 h-7 group-hover:animate-pulse"
                aria-hidden="true"
              />
            </button>
          </>
        )
      }

      <!-- Grid/Slider -->
      <div
        id="project-slider"
        class={`flex gap-6 md:gap-8 ${projects.length === 1 ? "justify-center" : "overflow-x-auto snap-x snap-mandatory scrollbar-hide pb-12 scroll-smooth px-4 md:px-0 -mx-4 md:mx-0"}`}
      >
        {
          projects.map((project, index) => (
            <div
              data-aos="fade-up"
              data-aos-delay={index * 100}
              class="w-[320px] md:w-[420px] flex-shrink-0 snap-center group relative rounded-[2.5rem] bg-white/[0.03] backdrop-blur-3xl border border-white/10 hover:border-brand-primary/50 transition-all duration-700 overflow-hidden glow-card"
            >
              <div
                class={`relative h-56 md:h-64 overflow-hidden bg-gradient-to-br ${project.color}`}
              >
                {project.image ? (
                  <Image
                    src={project.image}
                    alt={`Screenshot of ${project.title}`}
                    loading="lazy"
                    width={800}
                    height={600}
                    format="webp"
                    class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000 grayscale-[20%] group-hover:grayscale-0"
                  />
                ) : (
                  <div
                    class="absolute inset-0 flex items-center justify-center group-hover:scale-110 transition-transform duration-1000"
                    aria-hidden="true"
                  >
                    <div class="text-brand-primary/40 text-7xl md:text-8xl">
                      {project.icon}
                    </div>
                  </div>
                )}

                <div class="absolute inset-0 bg-brand-dark/40 opacity-0 group-hover:opacity-100 transition-opacity duration-700 backdrop-blur-[2px]" />

                {project.featured && (
                  <div class="absolute top-5 right-5 z-10">
                    <span class="px-4 py-1.5 text-[10px] font-black uppercase tracking-widest bg-brand-primary text-white rounded-full shadow-xl shadow-brand-primary/30">
                      First Project
                    </span>
                  </div>
                )}
              </div>

              <div class="p-8 md:p-10">
                <div class="text-[10px] text-brand-secondary mb-3 font-black uppercase tracking-[0.2em] translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-700">
                  {project.client}
                </div>
                <h3 class="text-2xl md:text-3xl font-black text-white mb-4 group-hover:text-brand-primary transition-colors duration-500">
                  {project.title}
                </h3>
                <p class="text-brand-light/60 mb-8 leading-relaxed text-sm md:text-base line-clamp-3">
                  {project.description}
                </p>

                <div class="flex flex-wrap gap-2 mb-8">
                  {project.tech.map((t) => (
                    <span class="px-3 py-1 text-[10px] font-bold bg-white/5 text-brand-light/70 rounded-lg border border-white/10 group-hover:border-brand-primary/30 transition-colors">
                      {t}
                    </span>
                  ))}
                </div>

                <div class="flex items-center justify-between gap-4">
                  {project.link && (
                    <a
                      href={project.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      aria-label={`Visit ${project.title} live website`}
                      class="p-3 rounded-xl bg-brand-primary/10 text-brand-primary border border-brand-primary/20 hover:bg-brand-primary hover:text-white transition-all duration-500 group/btn"
                    >
                      <ExternalLink className="w-5 h-5 group-hover/btn:scale-110 transition-transform" />
                    </a>
                  )}
                </div>
              </div>
            </div>
          ))
        }
      </div>
    </div>

    <!-- Pagination Dots -->
    {
      projects.length > 1 && (
        <div
          id="project-dots"
          class="flex justify-center gap-1 mt-8"
          role="tablist"
        >
          {projects.map((_, i) => (
            <div
              role="tab"
              aria-label={`Go to project ${i + 1}`}
              aria-selected={i === 0 ? "true" : "false"}
              class="p-2 cursor-pointer group"
            >
              <div
                class={`h-2 rounded-full transition-all duration-300 ${i === 0 ? "w-8 bg-brand-primary" : "w-2 bg-white/20 group-hover:bg-white/40"}`}
              />
            </div>
          ))}
        </div>
      )
    }
  </div>
</section>

<script>
  const slider = document.getElementById("project-slider");
  const prevBtn = document.getElementById("project-prev");
  const nextBtn = document.getElementById("project-next");
  const dots = document.querySelectorAll("#project-dots > div"); // Correct selector for dots
  const cards = slider?.querySelectorAll(".glow-card") || [];

  if (slider && cards.length > 1) {
    let cachedScrollAmount = 0;

    const updateCache = () => {
      const card = cards[0] as HTMLElement;
      const style = window.getComputedStyle(slider);
      const gap = parseInt(style.gap) || 0;
      cachedScrollAmount = card.offsetWidth + gap;
    };

    updateCache();
    window.addEventListener("resize", updateCache, { passive: true });

    if (prevBtn) {
      prevBtn.addEventListener("click", () => {
        slider.scrollBy({ left: -cachedScrollAmount, behavior: "smooth" });
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        slider.scrollBy({ left: cachedScrollAmount, behavior: "smooth" });
      });
    }

    const updateDots = (activeIndex: number) => {
      dots.forEach((dotWrapper, i) => {
        const dot = dotWrapper.querySelector("div");
        if (dot) {
          if (i === activeIndex) {
            dot.classList.remove("w-2", "bg-white/20");
            dot.classList.add("w-8", "bg-brand-primary");
            dotWrapper.setAttribute("aria-selected", "true");
          } else {
            dot.classList.remove("w-8", "bg-brand-primary");
            dot.classList.add("w-2", "bg-white/20");
            dotWrapper.setAttribute("aria-selected", "false");
          }
        }
      });
    };

    const observerOptions = {
      root: slider,
      threshold: 0.6, // Higher threshold for more definitive active state
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const index = Array.from(cards).indexOf(entry.target as Element);
          if (index !== -1) {
            updateDots(index);
          }
        }
      });
    }, observerOptions);

    cards.forEach((card) => observer.observe(card));

    // Handle clicks on dots
    dots.forEach((dot, i) => {
      dot.addEventListener("click", () => {
        slider.scrollTo({
          left: i * cachedScrollAmount,
          behavior: "smooth",
        });
      });
    });
  }
</script>
